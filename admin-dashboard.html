<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Äì Ara</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      display: flex;
    }
    aside {
      width: 220px;
      background: #2c3e50;
      color: white;
      height: 100vh;
      padding-top: 20px;
      position: fixed;
    }
    aside h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    aside ul {
      list-style: none;
      padding: 0;
    }
    aside ul li {
      padding: 15px 20px;
      cursor: pointer;
    }
    aside ul li:hover,
    aside ul li.active {
      background: #34495e;
    }
    main {
      margin-left: 220px;
      padding: 20px;
      flex-grow: 1;
    }
    .topbar {
      background: white;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section {
      background: white;
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .stats-grid {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: #3498db;
      color: white;
      flex: 1;
      padding: 20px;
      border-radius: 8px;
      min-width: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f2f2f2;
    }
    button {
      padding: 5px 10px;
      background: crimson;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.approve {
      background: #2ecc71;
    }
    input[type="text"] {
      padding: 6px;
      margin-top: 10px;
      width: 300px;
    }
  </style>
</head>
<body>

<aside>
  <h2>Admin</h2>
  <ul>
    <li onclick="showSection('stats')" class="active">üìä Dashboard</li>
    <li onclick="showSection('users')">üë• Manage Users</li>
    <li onclick="showSection('products')">üõí Products</li>
    <li onclick="showSection('disputes')">‚ö†Ô∏è Disputes</li>
    <li onclick="showSection('portfolios')">üñºÔ∏è Portfolios</li>
    <li onclick="showSection('rejectedPortfolios')">‚ùå Rejected</li>
    <li onclick="showSection('chats')">üí¨ Chat Logs</li>
    <li onclick="showSection('chatUser')">‚úâÔ∏è Message User</li>
  </ul>
</aside>

<main>
  <div class="topbar">
    <strong>Welcome, Admin</strong>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div id="stats" class="section">
    <h3>Platform Stats</h3>
    <div class="stats-grid">
      <div class="stat-card">Users: <span id="stat-users">0</span></div>
      <div class="stat-card">Products: <span id="stat-products">0</span></div>
      <div class="stat-card">Portfolios: <span id="stat-portfolios">0</span></div>
      <div class="stat-card">Earnings: $<span id="stat-earnings">0</span></div>
    </div>
    <canvas id="earningsChart" style="margin-top: 30px;" height="100"></canvas>
  </div>

  <div id="users" class="section" style="display:none;">
    <h3>All Users</h3>
    <table id="userTable"><thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="products" class="section" style="display:none;">
    <h3>Products</h3>
    <table id="productTable"><thead><tr><th>Title</th><th>Category</th><th>Price</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="disputes" class="section" style="display:none;">
    <h3>Disputes</h3>
    <table id="reportTable"><thead><tr><th>From</th><th>Against</th><th>Message</th><th>Date</th><th>Reply</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="portfolios" class="section" style="display:none;">
    <h3>Portfolios</h3>
    <table id="portfolioTable"><thead><tr><th>Title</th><th>Owner</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="rejectedPortfolios" class="section" style="display:none;">
    <h3>Rejected Portfolios</h3>
    <table id="rejectedTable"><thead><tr><th>Title</th><th>Owner</th><th>Date</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="chats" class="section" style="display:none;">
    <h3>Chat Logs</h3>
    <table id="chatTable"><thead><tr><th>From</th><th>Message</th><th>Time</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="chatUser" class="section" style="display:none;">
    <h3>Message User</h3>
    <input type="text" id="chatTo" placeholder="Recipient Email" />
    <input type="text" id="chatMsg" placeholder="Your message" />
    <button onclick="sendAdminMessage()">Send</button>
  </div>
</main>

<script>
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if (!user || user.userType !== "admin") {
    alert("Access denied");
    location.href = "login.html";
  }

  const users = JSON.parse(localStorage.getItem("users")) || [];
  const gigs = JSON.parse(localStorage.getItem("gigs")) || [];
  const portfolios = JSON.parse(localStorage.getItem("portfolios")) || [];
  const reports = JSON.parse(localStorage.getItem("reports")) || [];
  const chats = JSON.parse(localStorage.getItem("chatLogs")) || [];

  document.getElementById("stat-users").textContent = users.length;
  document.getElementById("stat-products").textContent = gigs.length;
  document.getElementById("stat-portfolios").textContent = portfolios.length;
  document.getElementById("stat-earnings").textContent = gigs.reduce((sum, g) => sum + Number(g.price || 0), 0);

  users.forEach(u => {
    document.querySelector("#userTable tbody").innerHTML += `
      <tr><td>${u.fullname}</td><td>${u.email}</td><td>${u.userType}</td>
      <td><button onclick="removeUser('${u.email}')">Remove</button></td></tr>`;
  });

  gigs.forEach(g => {
    document.querySelector("#productTable tbody").innerHTML += `
      <tr><td>${g.title}</td><td>${g.category}</td><td>$${g.price}</td>
      <td><button onclick="removeGig('${g.id}')">Remove</button></td></tr>`;
  });

  reports.forEach(r => {
    document.querySelector("#reportTable tbody").innerHTML += `
      <tr><td>${r.fromName}</td><td>${r.against||'N/A'}</td><td>${r.message}</td>
      <td>${new Date(r.date).toLocaleString()}</td>
      <td><a href="mailto:${r.fromEmail}?subject=Regarding your report&body=${encodeURIComponent(r.message)}">Email</a></td></tr>`;
  });

  portfolios.forEach(p => {
    const html = `
      <tr><td>${p.title}</td><td>${p.owner}</td><td>${p.approved ? 'Approved' : 'Pending'}</td>
      <td><button class="approve" onclick="approvePortfolio('${p.id}')">Approve</button>
      <button onclick="removePortfolio('${p.id}')">Remove</button></td></tr>`;
    if (p.approved) {
      document.querySelector("#portfolioTable tbody").innerHTML += html;
    } else {
      document.querySelector("#rejectedTable tbody").innerHTML += html;
    }
  });

  chats.forEach(c => {
    document.querySelector("#chatTable tbody").innerHTML += `
      <tr><td>${c.fromName}</td><td>${c.text}</td><td>${new Date(c.time).toLocaleString()}</td>
      <td><button onclick="deleteMessage('${c.id}')">Delete</button></td></tr>`;
  });

  function logout() {
    localStorage.removeItem("currentUser");
    location.href = "login.html";
  }

  function removeUser(email) {
    localStorage.setItem("users", JSON.stringify(users.filter(u => u.email !== email)));
    alert("User removed"); location.reload();
  }

  function removeGig(id) {
    localStorage.setItem("gigs", JSON.stringify(gigs.filter(g => g.id !== id)));
    alert("Gig removed"); location.reload();
  }

  function removePortfolio(id) {
    localStorage.setItem("portfolios", JSON.stringify(portfolios.filter(p => p.id !== id)));
    alert("Portfolio removed"); location.reload();
  }

  function approvePortfolio(id) {
    const index = portfolios.findIndex(p => p.id === id);
    if (index !== -1) {
      portfolios[index].approved = true;
      localStorage.setItem("portfolios", JSON.stringify(portfolios));
      alert("Approved"); location.reload();
    }
  }

  function deleteMessage(id) {
    localStorage.setItem("chatLogs", JSON.stringify(chats.filter(c => c.id !== id)));
    alert("Message deleted"); location.reload();
  }

  function sendAdminMessage() {
    const to = document.getElementById("chatTo").value.trim();
    const msg = document.getElementById("chatMsg").value.trim();
    if (!to || !msg) return alert("Fill all fields");

    const logs = JSON.parse(localStorage.getItem("chatLogs")) || [];

    logs.push({
      id: Date.now().toString(),
      fromName: "Admin",
      to: to, // ‚úÖ Must be `to` so user can read it
      text: msg,
      time: new Date().toISOString(),
      read: false
    });

    localStorage.setItem("chatLogs", JSON.stringify(logs));
    alert("Message sent");
    document.getElementById("chatMsg").value = "";
  }

  function showSection(id) {
    document.querySelectorAll(".section").forEach(s => s.style.display = "none");
    document.getElementById(id).style.display = "block";
    document.querySelectorAll("aside ul li").forEach(li => li.classList.remove("active"));
    event.target.classList.add("active");
  }

  const ctx = document.getElementById('earningsChart').getContext('2d');
  const monthlyEarnings = Array(12).fill(0);
  gigs.forEach(g => {
    const month = new Date(g.createdAt || new Date()).getMonth();
    monthlyEarnings[month] += Number(g.price || 0);
  });

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets: [{
        label: "Monthly Earnings ($)",
        data: monthlyEarnings,
        backgroundColor: 'rgba(46,204,113,0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }},
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
</body>
</html>
